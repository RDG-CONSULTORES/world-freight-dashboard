<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç World Freight Global Dashboard - Super Functional Edition</title>
    
    <!-- Plotly.js CDN - Real World Maps Engine -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* CSS Variables */
        :root {
            --primary-cyan: #00d4ff;
            --primary-gold: #f59e0b;
            --primary-dark: #0a0e27;
            --secondary-dark: #1a1f37;
            --success-green: #00ff88;
            --danger-red: #ff4757;
            --warning-orange: #ff6b35;
            --text-primary: #ffffff;
            --text-secondary: #8b92a9;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(0, 212, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f37 50%, #0a0e27 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 100vh;
            gap: 1rem;
            padding: 1rem;
            max-width: 1900px;
            margin: 0 auto;
        }

        .control-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            height: fit-content;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }

        .control-section {
            margin-bottom: 2rem;
        }

        .control-title {
            color: var(--primary-cyan);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filter-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: left;
            font-family: 'Inter', sans-serif;
        }

        .filter-btn:hover {
            background: rgba(0, 212, 255, 0.15);
            border-color: var(--primary-cyan);
            color: var(--primary-cyan);
            transform: translateX(2px);
        }

        .filter-btn.active {
            background: rgba(0, 212, 255, 0.25);
            border-color: var(--primary-cyan);
            color: var(--primary-cyan);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.2);
        }

        .metric-value {
            color: var(--primary-cyan);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .map-container {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
        }

        .map-header {
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid var(--glass-border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-title {
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
            background: linear-gradient(45deg, #ffffff, #00d4ff, #ffffff);
            background-size: 300% 300%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleGlow 3s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .map-controls {
            display: flex;
            gap: 0.5rem;
        }

        .control-btn {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            color: var(--primary-cyan);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            font-family: 'Inter', sans-serif;
        }

        .control-btn:hover {
            background: rgba(0, 212, 255, 0.2);
            box-shadow: 0 0 12px rgba(0, 212, 255, 0.3);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Marker Style Selector - Updated with Visual Previews */
        .marker-style-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .marker-style-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.75rem 0.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.8rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .marker-style-btn:hover {
            background: rgba(0, 212, 255, 0.15);
            border-color: var(--primary-cyan);
            color: var(--primary-cyan);
        }

        .marker-style-btn.active {
            background: rgba(0, 212, 255, 0.25);
            border-color: var(--primary-cyan);
            color: var(--primary-cyan);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .style-preview {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-bottom: 8px;
            align-items: center;
        }

        .preview-hub {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .preview-hub.major {
            width: 12px;
            height: 12px;
            background: #ff4444;
        }

        .preview-hub.regional {
            width: 8px;
            height: 8px;
            background: #00ccff;
        }

        /* Aircraft Animation Controls */
        .animation-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .animation-btn {
            flex: 1;
            padding: 0.7rem;
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 8px;
            color: var(--warning-orange);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            text-align: center;
        }

        .animation-btn:hover {
            background: rgba(255, 107, 53, 0.2);
            box-shadow: 0 0 12px rgba(255, 107, 53, 0.3);
        }

        .animation-btn.active {
            background: rgba(255, 107, 53, 0.3);
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.4);
        }

        /* Legend Styles */
        .hub-legend {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .legend-line {
            width: 20px;
            height: 2px;
            border-radius: 1px;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 14, 39, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 212, 255, 0.3);
            border-top: 3px solid var(--primary-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .control-panel {
                order: 2;
                margin-top: 1rem;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        
        <!-- Control Panel -->
        <div class="control-panel">
            
            <!-- System Status -->
            <div class="control-section">
                <h3 class="control-title">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">local_shipping</span>
                    Global Freight Status
                </h3>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>Global Network Operational</span>
                </div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="total-hubs">20</div>
                        <div class="metric-label">Cargo Hubs</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="total-cargo">45.2M</div>
                        <div class="metric-label">Tons/Year</div>
                    </div>
                </div>
            </div>

            <!-- Hub Marker Styles -->
            <div class="control-section">
                <h3 class="control-title">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">palette</span>
                    Marker Styles
                </h3>
                
                <div class="marker-style-selector">
                    <button class="marker-style-btn active" onclick="changeMarkerStyle('classic')" id="style-classic">
                        <div class="style-preview">
                            <div class="preview-hub major" style="border-radius: 50%;"></div>
                            <div class="preview-hub regional" style="border-radius: 50%;"></div>
                        </div>
                        Classic Airport
                    </button>
                    <button class="marker-style-btn" onclick="changeMarkerStyle('modern')" id="style-modern">
                        <div class="style-preview">
                            <div class="preview-hub major" style="border-radius: 0%; transform: rotate(45deg);"></div>
                            <div class="preview-hub regional" style="border-radius: 0%;"></div>
                        </div>
                        Modern Geometric
                    </button>
                    <button class="marker-style-btn" onclick="changeMarkerStyle('aviation')" id="style-aviation">
                        <div class="style-preview">
                            <div class="preview-hub major" style="border-radius: 0%; transform: rotate(45deg); background: #ffe66d;"></div>
                            <div class="preview-hub regional" style="background: #95e1d3;"></div>
                        </div>
                        Aviation Professional
                    </button>
                    <button class="marker-style-btn" onclick="changeMarkerStyle('corporate')" id="style-corporate">
                        <div class="style-preview">
                            <div class="preview-hub major" style="background: transparent; border: 2px solid #a8e6cf;"></div>
                            <div class="preview-hub regional" style="border-radius: 0%; background: #c7ceea;"></div>
                        </div>
                        Corporate Clean
                    </button>
                </div>
            </div>

            <!-- Real-time Aircraft Animation -->
            <div class="control-section">
                <h3 class="control-title">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">flight</span>
                    Live Aircraft Tracking
                </h3>
                
                <div class="animation-controls">
                    <button class="animation-btn" onclick="toggleAircraftAnimation()" id="aircraft-btn">
                        <span class="material-icons" style="font-size: 14px;">play_arrow</span>
                        Start Live Tracking
                    </button>
                </div>
                
                <div class="metrics-grid" style="margin-top: 1rem;">
                    <div class="metric-card">
                        <div class="metric-value" id="active-flights">0</div>
                        <div class="metric-label">Active Flights</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="flight-speed">2.5x</div>
                        <div class="metric-label">Animation Speed</div>
                    </div>
                </div>
            </div>

            <!-- Network Filters -->
            <div class="control-section">
                <h3 class="control-title">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">tune</span>
                    Network Filters
                </h3>
                
                <div class="filter-group">
                    <button class="filter-btn active" onclick="filterByType('all')" id="filter-all">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">public</span>
                        All Hubs (20)
                    </button>
                    <button class="filter-btn" onclick="filterByType('major')" id="filter-major">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">star</span>
                        Major Hubs (8)
                    </button>
                    <button class="filter-btn" onclick="filterByType('regional')" id="filter-regional">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">place</span>
                        Regional Hubs (12)
                    </button>
                </div>

                <div class="filter-group" style="margin-top: 1.5rem;">
                    <button class="filter-btn" onclick="filterByRegion('americas')" id="filter-americas">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">map</span>
                        Americas
                    </button>
                    <button class="filter-btn" onclick="filterByRegion('europe')" id="filter-europe">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">map</span>
                        Europe
                    </button>
                    <button class="filter-btn" onclick="filterByRegion('asia')" id="filter-asia">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">map</span>
                        Asia-Pacific
                    </button>
                </div>
            </div>

            <!-- Globe Controls -->
            <div class="control-section">
                <h3 class="control-title">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">3d_rotation</span>
                    Globe Controls
                </h3>
                
                <div class="filter-group">
                    <button class="filter-btn" onclick="rotateGlobe()" id="rotate-btn">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">rotate_right</span>
                        Auto-Rotate
                    </button>
                    <button class="filter-btn" onclick="resetView()" id="reset-btn">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">my_location</span>
                        Global View
                    </button>
                    <button class="filter-btn" onclick="focusAmericas()" id="americas-btn">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">place</span>
                        Focus Americas
                    </button>
                    <button class="filter-btn" onclick="focusEurope()" id="europe-btn">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">place</span>
                        Focus Europe
                    </button>
                    <button class="filter-btn" onclick="focusAsia()" id="asia-btn">
                        <span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">place</span>
                        Focus Asia
                    </button>
                </div>
            </div>

            <!-- Global Metrics -->
            <div class="control-section">
                <h3 class="control-title">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">analytics</span>
                    Global Metrics
                </h3>
                
                <div class="metric-card" style="margin-bottom: 1rem;">
                    <div class="metric-value" id="total-routes">8</div>
                    <div class="metric-label">Main Routes</div>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="avg-distance">8.2K</div>
                        <div class="metric-label">Avg Distance (km)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="efficiency">94%</div>
                        <div class="metric-label">Network Efficiency</div>
                    </div>
                </div>
            </div>

            <!-- Visual Legend -->
            <div class="control-section">
                <h3 class="control-title">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">legend_toggle</span>
                    Visual Legend
                </h3>
                
                <div class="hub-legend">
                    <div style="font-weight: 600; margin-bottom: 10px; color: var(--primary-cyan);">CARGO HUBS:</div>
                    
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #ff4444; border-radius: 50%;"></div>
                        <span><strong>Major Hubs</strong> - 4M+ tons/year</span>
                    </div>
                    
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #00ccff; border-radius: 50%;"></div>
                        <span><strong>Regional Hubs</strong> - 1-4M tons/year</span>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: var(--primary-cyan);">ROUTES & AIRCRAFT:</div>
                        <div class="legend-item">
                            <div class="legend-line" style="background: #00bcd4;"></div>
                            <span>Solid line - Main routes</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-line" style="background: #4caf50; background-image: repeating-linear-gradient(90deg, transparent, transparent 2px, white 2px, white 4px);"></div>
                            <span>Dotted line - Regional routes</span>
                        </div>
                        <div class="legend-item">
                            <span style="font-size: 14px;">‚úàÔ∏è</span>
                            <span>Live aircraft on routes</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Geographic Context -->
            <div class="control-section">
                <h3 class="control-title">
                    <span class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">info</span>
                    Technical Info
                </h3>
                
                <div style="font-size: 0.85rem; line-height: 1.6; color: var(--text-secondary);">
                    <div style="margin-bottom: 8px;">
                        üåç <strong style="color: var(--primary-cyan);">REAL WORLD MAPS:</strong><br>
                        Plotly.js orthographic projection with actual country borders
                    </div>
                    <div style="margin-bottom: 8px;">
                        ‚úàÔ∏è <strong style="color: var(--success-green);">LIVE AIRCRAFT:</strong><br>
                        Great circle path interpolation with smooth animation
                    </div>
                    <div style="margin-bottom: 8px;">
                        üñ±Ô∏è <strong style="color: var(--primary-gold);">MOUSE CONTROLS:</strong><br>
                        Drag to rotate globe, scroll to zoom in/out
                    </div>
                    <div>
                        üìä <strong style="color: var(--warning-orange);">DATA:</strong><br>
                        2024 cargo airport volumes with real airline operators
                    </div>
                </div>
            </div>
        </div>

        <!-- Globe Map Container -->
        <div class="map-container">
            <div class="map-header">
                <div class="map-title">
                    <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 8px;">public</span>
                    World Freight Network - Live Global View
                </div>
                <div class="map-controls">
                    <button class="control-btn" onclick="takeScreenshot()">
                        <span class="material-icons" style="font-size: 14px;">photo_camera</span>
                        Screenshot
                    </button>
                    <button class="control-btn" onclick="toggleFullscreen()">
                        <span class="material-icons" style="font-size: 14px;">fullscreen</span>
                        Fullscreen
                    </button>
                </div>
            </div>
            
            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loading">
                <div style="text-align: center;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 1rem; color: var(--primary-cyan);">Loading Real World Maps...</p>
                    <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">Initializing Plotly.js 3D Globe...</p>
                </div>
            </div>
            
            <!-- 3D Globe -->
            <div id="world-globe" style="width: 100%; height: calc(100% - 70px);"></div>
        </div>
    </div>

    <script>
        // World Freight Data - Comprehensive Dataset
        const WORLD_FREIGHT_DATA = {
            hubs: [
                // Americas - Major Hubs
                {name: "Memphis (MEM)", lat: 35.0424, lng: -89.9767, cargo: 4613000, type: "major", region: "americas", company: "FedEx", code: "MEM"},
                {name: "Anchorage (ANC)", lat: 61.1744, lng: -149.9961, cargo: 3162000, type: "major", region: "americas", company: "UPS/FedEx", code: "ANC"},
                {name: "Los Angeles (LAX)", lat: 34.0522, lng: -118.2437, cargo: 2268000, type: "major", region: "americas", company: "Multiple", code: "LAX"},
                {name: "Chicago (ORD)", lat: 41.9742, lng: -87.9073, cargo: 1435000, type: "regional", region: "americas", company: "United/AA", code: "ORD"},
                {name: "Miami (MIA)", lat: 25.7959, lng: -80.2870, cargo: 2340000, type: "major", region: "americas", company: "American", code: "MIA"},
                
                // Europe - Major Hubs
                {name: "Frankfurt (FRA)", lat: 50.0379, lng: 8.5622, cargo: 2280000, type: "major", region: "europe", company: "Lufthansa Cargo", code: "FRA"},
                {name: "Paris (CDG)", lat: 49.0097, lng: 2.5479, cargo: 2180000, type: "major", region: "europe", company: "Air France", code: "CDG"},
                {name: "London (LHR)", lat: 51.4700, lng: -0.4543, cargo: 1770000, type: "regional", region: "europe", company: "British Airways", code: "LHR"},
                {name: "Amsterdam (AMS)", lat: 52.3105, lng: 4.7683, cargo: 1740000, type: "regional", region: "europe", company: "KLM Cargo", code: "AMS"},
                {name: "Li√®ge (LGG)", lat: 50.6374, lng: 5.4432, cargo: 1040000, type: "regional", region: "europe", company: "TNT/FedEx", code: "LGG"},
                
                // Asia-Pacific - Major Hubs
                {name: "Hong Kong (HKG)", lat: 22.3080, lng: 113.9185, cargo: 4520000, type: "major", region: "asia", company: "Cathay Pacific", code: "HKG"},
                {name: "Shanghai (PVG)", lat: 31.1443, lng: 121.8083, cargo: 3630000, type: "major", region: "asia", company: "China Cargo", code: "PVG"},
                {name: "Seoul (ICN)", lat: 37.4602, lng: 126.4407, cargo: 2840000, type: "major", region: "asia", company: "Korean Air", code: "ICN"},
                {name: "Tokyo (NRT)", lat: 35.7720, lng: 140.3929, cargo: 2180000, type: "regional", region: "asia", company: "JAL/ANA", code: "NRT"},
                {name: "Singapore (SIN)", lat: 1.3644, lng: 103.9915, cargo: 2030000, type: "regional", region: "asia", company: "Singapore Airlines", code: "SIN"},
                {name: "Taipei (TPE)", lat: 25.0797, lng: 121.2342, cargo: 2230000, type: "regional", region: "asia", company: "China Airlines", code: "TPE"},
                
                // Middle East & Others
                {name: "Dubai (DXB)", lat: 25.2532, lng: 55.3657, cargo: 2650000, type: "major", region: "asia", company: "Emirates", code: "DXB"},
                {name: "Doha (DOH)", lat: 25.2731, lng: 51.6080, cargo: 1450000, type: "regional", region: "asia", company: "Qatar Airways", code: "DOH"},
                {name: "S√£o Paulo (GRU)", lat: -23.4356, lng: -46.4731, cargo: 580000, type: "regional", region: "americas", company: "LATAM", code: "GRU"},
                {name: "Sydney (SYD)", lat: -33.9399, lng: 151.1753, cargo: 580000, type: "regional", region: "asia", company: "Qantas", code: "SYD"}
            ],
            
            routes: [
                // Trans-Pacific Powerhouses
                {from: "HKG", to: "MEM", volume: 285000, color: '#00bcd4', type: "major", id: "HKG-MEM"},
                {from: "PVG", to: "LAX", volume: 240000, color: '#4caf50', type: "major", id: "PVG-LAX"},
                {from: "NRT", to: "ANC", volume: 195000, color: '#ff9800', type: "major", id: "NRT-ANC"},
                
                // Trans-Atlantic Corridors
                {from: "FRA", to: "ORD", volume: 180000, color: '#9c27b0', type: "major", id: "FRA-ORD"},
                {from: "LHR", to: "MEM", volume: 165000, color: '#f44336', type: "major", id: "LHR-MEM"},
                
                // Europe-Asia Silk Road
                {from: "AMS", to: "HKG", volume: 145000, color: '#3f51b5', type: "regional", id: "AMS-HKG"},
                
                // Middle East Gateway
                {from: "DXB", to: "FRA", volume: 125000, color: '#ff5722', type: "regional", id: "DXB-FRA"},
                {from: "SIN", to: "DXB", volume: 98000, color: '#795548', type: "regional", id: "SIN-DXB"}
            ]
        };

        // Current State Variables
        let currentFilter = 'all';
        let currentRegion = 'all';
        let currentMarkerStyle = 'classic';
        let isRotating = false;
        let rotationInterval;
        let isAircraftAnimating = false;
        let aircraftInterval;
        let aircraftPositions = [];
        let lastAircraftUpdate = 0;

        // Enhanced Marker Style Definitions with Real Airport-Style Icons
        const MARKER_STYLES = {
            classic: {
                major: { 
                    symbol: 'circle', 
                    size: [35, 70], 
                    color: '#ff4444', 
                    line: { width: 3, color: '#ffffff' },
                    opacity: 0.9
                },
                regional: { 
                    symbol: 'circle', 
                    size: [22, 45], 
                    color: '#00ccff', 
                    line: { width: 2, color: '#ffffff' },
                    opacity: 0.85
                }
            },
            modern: {
                major: { 
                    symbol: 'diamond', 
                    size: [32, 65], 
                    color: '#ff6b6b', 
                    line: { width: 3, color: '#ffffff' },
                    opacity: 0.9
                },
                regional: { 
                    symbol: 'square', 
                    size: [20, 42], 
                    color: '#4ecdc4', 
                    line: { width: 2, color: '#ffffff' },
                    opacity: 0.85
                }
            },
            aviation: {
                major: { 
                    symbol: 'diamond', 
                    size: [38, 68], 
                    color: '#ffe66d', 
                    line: { width: 3, color: '#000000' },
                    opacity: 0.95
                },
                regional: { 
                    symbol: 'cross-thin', 
                    size: [24, 44], 
                    color: '#95e1d3', 
                    line: { width: 2, color: '#000000' },
                    opacity: 0.9
                }
            },
            corporate: {
                major: { 
                    symbol: 'circle-open', 
                    size: [42, 75], 
                    color: '#a8e6cf', 
                    line: { width: 4, color: '#ffffff' },
                    opacity: 0.8
                },
                regional: { 
                    symbol: 'square', 
                    size: [20, 40], 
                    color: '#c7ceea', 
                    line: { width: 2, color: '#ffffff' },
                    opacity: 0.85
                }
            }
        };

        // Aircraft symbols for realistic animation
        const AIRCRAFT_ICONS = ['‚úà', 'üõ´', 'üõ¨', 'üöÅ'];

        // Utility Functions
        function getHubByCode(code) {
            return WORLD_FREIGHT_DATA.hubs.find(hub => hub.code === code);
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Great Circle Interpolation for Realistic Flight Paths
        function interpolateGreatCircle(lat1, lng1, lat2, lng2, fraction) {
            const phi1 = lat1 * Math.PI / 180;
            const phi2 = lat2 * Math.PI / 180;
            const deltaLng = (lng2 - lng1) * Math.PI / 180;
            
            const A = Math.sin((1 - fraction) * Math.acos(Math.sin(phi1) * Math.sin(phi2) + Math.cos(phi1) * Math.cos(phi2) * Math.cos(deltaLng))) / Math.sin(Math.acos(Math.sin(phi1) * Math.sin(phi2) + Math.cos(phi1) * Math.cos(phi2) * Math.cos(deltaLng)));
            const B = Math.sin(fraction * Math.acos(Math.sin(phi1) * Math.sin(phi2) + Math.cos(phi1) * Math.cos(phi2) * Math.cos(deltaLng))) / Math.sin(Math.acos(Math.sin(phi1) * Math.sin(phi2) + Math.cos(phi1) * Math.cos(phi2) * Math.cos(deltaLng)));
            
            const x = A * Math.cos(phi1) * Math.cos(lng1 * Math.PI / 180) + B * Math.cos(phi2) * Math.cos(lng2 * Math.PI / 180);
            const y = A * Math.cos(phi1) * Math.sin(lng1 * Math.PI / 180) + B * Math.cos(phi2) * Math.sin(lng2 * Math.PI / 180);
            const z = A * Math.sin(phi1) + B * Math.sin(phi2);
            
            const lat = Math.atan2(z, Math.sqrt(x * x + y * y)) * 180 / Math.PI;
            const lng = Math.atan2(y, x) * 180 / Math.PI;
            
            return { lat, lng };
        }

        // Initialize Globe
        function initializeGlobe() {
            console.log('üåç Initializing Super Functional World Freight Globe...');
            
            setTimeout(() => {
                document.getElementById('loading').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 500);
            }, 1500);

            updateGlobe();
        }

        // Main Globe Update Function
        function updateGlobe(filterType = 'all', regionFilter = 'all') {
            console.log('üîÑ Updating globe:', { filterType, regionFilter, markerStyle: currentMarkerStyle });
            
            let hubs = WORLD_FREIGHT_DATA.hubs.slice(); // Create copy
            let routes = WORLD_FREIGHT_DATA.routes.slice(); // Create copy

            // Apply filters
            if (filterType !== 'all') {
                hubs = hubs.filter(h => h.type === filterType);
            }
            
            if (regionFilter !== 'all') {
                hubs = hubs.filter(h => h.region === regionFilter);
            }

            const traces = [];
            const style = MARKER_STYLES[currentMarkerStyle];

            // 1. Enhanced Cargo Hubs with Professional Styling
            hubs.forEach(hub => {
                const hubStyle = style[hub.type];
                const markerSize = Math.max(
                    hubStyle.size[0], 
                    Math.min(hub.cargo / 55000, hubStyle.size[1])
                );
                
                traces.push({
                    type: 'scattergeo',
                    lat: [hub.lat],
                    lon: [hub.lng],
                    text: [hub.name.split(' (')[0]],
                    mode: 'markers+text',
                    marker: {
                        size: markerSize,
                        color: hubStyle.color,
                        line: hubStyle.line,
                        symbol: hubStyle.symbol,
                        opacity: hubStyle.opacity
                    },
                    textposition: 'bottom center',
                    textfont: { size: 12, color: 'white', family: 'Inter', weight: 600 },
                    name: `${hub.type}_hub`,
                    showlegend: false,
                    hovertemplate: '<b>üè¢ ' + hub.name + '</b><br>' +
                                 'üìä Type: ' + hub.type.charAt(0).toUpperCase() + hub.type.slice(1) + ' Hub<br>' +
                                 'üì¶ Annual Cargo: ' + (hub.cargo / 1000000).toFixed(1) + 'M tons<br>' +
                                 'üåç Region: ' + hub.region.charAt(0).toUpperCase() + hub.region.slice(1) + '<br>' +
                                 '‚úàÔ∏è Primary Operator: ' + hub.company + '<br>' +
                                 'üéØ Airport Code: ' + hub.code + '<extra></extra>'
                });

                // Add subtle glow effect for major hubs
                if (hub.type === 'major') {
                    traces.push({
                        type: 'scattergeo',
                        lat: [hub.lat],
                        lon: [hub.lng],
                        mode: 'markers',
                        marker: {
                            size: markerSize + 15,
                            color: hubStyle.color,
                            line: { width: 0 },
                            symbol: 'circle',
                            opacity: 0.2
                        },
                        showlegend: false,
                        hoverinfo: 'skip'
                    });
                }
            });

            // 2. Ultra-Fine Route Lines with Enhanced Styling
            routes.forEach(route => {
                const fromHub = getHubByCode(route.from);
                const toHub = getHubByCode(route.to);
                
                if (!fromHub || !toHub) return;

                let lineWidth, lineOpacity, lineDash;
                
                if (route.type === 'major') {
                    lineWidth = Math.max(1.5, Math.min(route.volume / 45000, 3.5));
                    lineOpacity = 0.8;
                    lineDash = 'solid';
                } else {
                    lineWidth = Math.max(1.0, Math.min(route.volume / 55000, 2.2));
                    lineOpacity = 0.7;
                    lineDash = 'dot';
                }

                // Shadow for depth
                traces.push({
                    type: 'scattergeo',
                    lat: [fromHub.lat, toHub.lat],
                    lon: [fromHub.lng, toHub.lng],
                    mode: 'lines',
                    line: {
                        width: lineWidth + 0.8,
                        color: 'rgba(0, 0, 0, 0.25)',
                        opacity: 0.15
                    },
                    showlegend: false,
                    hoverinfo: 'skip',
                    name: 'route_shadow'
                });

                // Main route line
                traces.push({
                    type: 'scattergeo',
                    lat: [fromHub.lat, toHub.lat],
                    lon: [fromHub.lng, toHub.lng],
                    mode: 'lines',
                    line: {
                        width: lineWidth,
                        color: route.color,
                        opacity: lineOpacity,
                        dash: lineDash
                    },
                    showlegend: false,
                    name: 'route_line',
                    hovertemplate: '<b>üõ´ Cargo Route</b><br>' +
                                 'üìç Origin: ' + fromHub.name.split(' (')[0] + ', ' + fromHub.country + '<br>' +
                                 'üìç Destination: ' + toHub.name.split(' (')[0] + ', ' + toHub.country + '<br>' +
                                 'üì¶ Annual Volume: ' + (route.volume / 1000).toFixed(0) + 'K tons<br>' +
                                 'üéØ Route Category: ' + route.type.charAt(0).toUpperCase() + route.type.slice(1) + '<br>' +
                                 'üìè Great Circle Distance: ~' + calculateDistance(fromHub.lat, fromHub.lng, toHub.lat, toHub.lng).toFixed(0) + ' km<br>' +
                                 '‚úàÔ∏è Estimated Flight Time: ~' + Math.round(calculateDistance(fromHub.lat, fromHub.lng, toHub.lat, toHub.lng) / 900) + ' hours<extra></extra>',
                    hoverinfo: 'text'
                });
            });

            // Enhanced Globe Layout with Optimized Settings
            const layout = {
                geo: {
                    scope: 'world',
                    projection: {
                        type: 'orthographic',
                        rotation: { lat: 15, lon: -30, roll: 0 }
                    },
                    showland: true,
                    landcolor: 'rgba(50, 60, 80, 0.95)',
                    showocean: true,
                    oceancolor: 'rgba(20, 30, 50, 0.98)',
                    showcountries: true,
                    countrycolor: 'rgba(0, 180, 255, 0.5)',
                    countrywidth: 0.8,
                    coastlinecolor: 'rgba(0, 220, 255, 0.7)',
                    coastlinewidth: 1.2,
                    showlakes: true,
                    lakecolor: 'rgba(20, 30, 50, 0.9)',
                    showrivers: false,
                    showsubunits: true,
                    subunitcolor: 'rgba(0, 150, 200, 0.25)',
                    subunitwidth: 0.5,
                    bgcolor: 'rgba(0,0,0,0)',
                    showframe: false,
                    framecolor: 'rgba(0,0,0,0)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: 'white', family: 'Inter', size: 12 },
                margin: { l: 0, r: 0, t: 0, b: 0 },
                showlegend: false,
                height: window.innerHeight - 150,
                hovermode: 'closest',
                dragmode: 'orbit'
            };

            // Render with Plotly - Clean slate approach with mouse controls
            const config = {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: [
                    'pan2d', 'select2d', 'lasso2d', 'autoScale2d', 
                    'toggleHover', 'toggleSpikelines', 'resetScale2d'
                ],
                modeBarButtonsToAdd: [
                    {
                        name: 'Orbit Rotation',
                        icon: Plotly.Icons.drawcircle,
                        click: function() {
                            console.log('Orbit mode enabled - drag to rotate globe');
                        }
                    }
                ],
                displaylogo: false,
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'world-freight-functional-globe',
                    height: 1200,
                    width: 1600,
                    scale: 2
                },
                scrollZoom: true,
                doubleClick: 'reset',
                showTips: false
            };

            Plotly.newPlot('world-globe', traces, layout, config).then(() => {
                // Enable mouse controls explicitly
                const globeDiv = document.getElementById('world-globe');
                
                // Ensure orbit drag mode is active
                Plotly.relayout('world-globe', {
                    dragmode: 'orbit'
                });
                
                // Add mouse event listeners for better responsiveness
                globeDiv.on('plotly_relayout', function(eventdata) {
                    if (eventdata['geo.projection.rotation.lon'] !== undefined) {
                        // Stop auto-rotation if user manually rotates
                        if (isRotating) {
                            clearInterval(rotationInterval);
                            isRotating = false;
                            const rotateBtn = document.getElementById('rotate-btn');
                            rotateBtn.classList.remove('active');
                            rotateBtn.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">rotate_right</span>Auto-Rotate';
                        }
                    }
                });
                
                console.log('üñ±Ô∏è Mouse controls enabled - drag to rotate globe');
            });
            
            updateMetrics(hubs, routes);
            console.log('‚úÖ Globe updated successfully with', traces.length, 'traces');
        }

        // Fixed Aircraft Animation System
        function toggleAircraftAnimation() {
            const button = document.getElementById('aircraft-btn');
            
            if (!isAircraftAnimating) {
                isAircraftAnimating = true;
                button.classList.add('active');
                button.innerHTML = '<span class="material-icons" style="font-size: 14px;">pause</span> Stop Tracking';
                
                initializeAircraftPositions();
                startAircraftAnimation();
                
                console.log('‚úàÔ∏è Aircraft animation started -', aircraftPositions.length, 'aircraft initialized');
            } else {
                isAircraftAnimating = false;
                button.classList.remove('active');
                button.innerHTML = '<span class="material-icons" style="font-size: 14px;">play_arrow</span> Start Live Tracking';
                
                stopAircraftAnimation();
                
                console.log('‚èπÔ∏è Aircraft animation stopped');
            }
        }

        function initializeAircraftPositions() {
            aircraftPositions = [];
            
            WORLD_FREIGHT_DATA.routes.forEach((route, routeIndex) => {
                const fromHub = getHubByCode(route.from);
                const toHub = getHubByCode(route.to);
                
                if (fromHub && toHub) {
                    const distance = calculateDistance(fromHub.lat, fromHub.lng, toHub.lat, toHub.lng);
                    const numAircraft = route.type === 'major' ? 2 : 1;
                    const baseSpeed = 0.001; // Base speed for animation
                    
                    for (let i = 0; i < numAircraft; i++) {
                        aircraftPositions.push({
                            id: `${route.from}-${route.to}-${i}`,
                            routeId: route.id,
                            fromHub: fromHub,
                            toHub: toHub,
                            progress: (i / numAircraft) * 0.8, // Stagger aircraft starts
                            speed: baseSpeed * (1 + Math.random() * 0.5), // Variable speeds
                            icon: AIRCRAFT_ICONS[Math.floor(Math.random() * AIRCRAFT_ICONS.length)],
                            distance: distance,
                            direction: 'forward' // Can be 'forward' or 'backward'
                        });
                    }
                }
            });
            
            document.getElementById('active-flights').textContent = aircraftPositions.length;
            console.log('üõ´ Aircraft positions initialized:', aircraftPositions.length, 'aircraft on', WORLD_FREIGHT_DATA.routes.length, 'routes');
        }

        function startAircraftAnimation() {
            aircraftInterval = setInterval(() => {
                if (!isAircraftAnimating) return;
                updateAndRenderAircraft();
            }, 150); // Update every 150ms for smooth animation
        }

        function stopAircraftAnimation() {
            if (aircraftInterval) {
                clearInterval(aircraftInterval);
                aircraftInterval = null;
            }
            
            // Clean removal of aircraft traces
            removeAllAircraftTraces();
            aircraftPositions = [];
            document.getElementById('active-flights').textContent = '0';
        }

        function updateAndRenderAircraft() {
            // Update positions
            aircraftPositions.forEach(aircraft => {
                aircraft.progress += aircraft.speed;
                
                // Loop aircraft when they reach the end
                if (aircraft.progress >= 1) {
                    aircraft.progress = 0;
                }
            });
            
            // Clean previous aircraft traces and add new ones
            removeAllAircraftTraces().then(() => {
                addAircraftTraces();
            });
        }

        function removeAllAircraftTraces() {
            return new Promise((resolve) => {
                const plotDiv = document.getElementById('world-globe');
                if (!plotDiv || !plotDiv.data) {
                    resolve();
                    return;
                }
                
                // Find indices of aircraft traces
                const aircraftIndices = [];
                plotDiv.data.forEach((trace, index) => {
                    if (trace.name && trace.name.startsWith('aircraft_')) {
                        aircraftIndices.push(index);
                    }
                });
                
                if (aircraftIndices.length > 0) {
                    Plotly.deleteTraces('world-globe', aircraftIndices).then(() => {
                        resolve();
                    }).catch(() => {
                        resolve(); // Continue even if delete fails
                    });
                } else {
                    resolve();
                }
            });
        }

        function addAircraftTraces() {
            const aircraftTraces = aircraftPositions.map((aircraft, index) => {
                // Use great circle interpolation for realistic flight paths
                const position = interpolateGreatCircle(
                    aircraft.fromHub.lat, aircraft.fromHub.lng,
                    aircraft.toHub.lat, aircraft.toHub.lng,
                    aircraft.progress
                );
                
                return {
                    type: 'scattergeo',
                    lat: [position.lat],
                    lon: [position.lng],
                    mode: 'text',
                    text: [aircraft.icon],
                    textfont: { 
                        size: 16, 
                        color: '#ffff00'  // Bright yellow for visibility
                    },
                    showlegend: false,
                    name: `aircraft_${index}`,
                    hovertemplate: '<b>‚úàÔ∏è Live Flight ' + aircraft.id + '</b><br>' +
                                 'üõ´ From: ' + aircraft.fromHub.name.split(' (')[0] + '<br>' +
                                 'üõ¨ To: ' + aircraft.toHub.name.split(' (')[0] + '<br>' +
                                 'üìä Progress: ' + Math.round(aircraft.progress * 100) + '%<br>' +
                                 'üìè Distance: ' + aircraft.distance.toFixed(0) + ' km<br>' +
                                 '‚è±Ô∏è ETA: ' + Math.round((1 - aircraft.progress) * 100) + '% remaining<extra></extra>',
                    hoverinfo: 'text'
                };
            });
            
            // Add all aircraft traces at once
            if (aircraftTraces.length > 0) {
                Plotly.addTraces('world-globe', aircraftTraces).catch(error => {
                    console.warn('‚ö†Ô∏è Failed to add aircraft traces:', error);
                });
            }
        }

        // Marker Style Changer with Proper State Management
        function changeMarkerStyle(style) {
            currentMarkerStyle = style;
            
            // Update active button
            document.querySelectorAll('.marker-style-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`style-${style}`).classList.add('active');
            
            // If aircraft are animating, stop them temporarily during update
            const wasAnimating = isAircraftAnimating;
            if (wasAnimating) {
                stopAircraftAnimation();
            }
            
            updateGlobe(currentFilter, currentRegion);
            
            // Restart aircraft animation if it was running
            if (wasAnimating) {
                setTimeout(() => {
                    toggleAircraftAnimation();
                }, 1000);
            }
            
            console.log('üé® Marker style changed to:', style);
        }

        // Filter Functions with State Management
        function filterByType(type) {
            currentFilter = type;
            
            document.querySelectorAll('[id^="filter-"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${type}`).classList.add('active');
            
            updateGlobe(type, currentRegion);
            console.log('üîç Filtered by type:', type);
        }

        function filterByRegion(region) {
            currentRegion = region;
            
            document.querySelectorAll('[id^="filter-"][id$="s"]').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${region}`).classList.add('active');
            
            updateGlobe(currentFilter, region);
            console.log('üåç Filtered by region:', region);
        }

        // 3D Globe Controls
        function rotateGlobe() {
            const button = document.getElementById('rotate-btn');
            
            if (!isRotating) {
                isRotating = true;
                button.classList.add('active');
                button.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">stop</span>Stop Rotation';
                
                let rotation = -30;
                rotationInterval = setInterval(() => {
                    rotation += 0.8; // Slower rotation
                    Plotly.relayout('world-globe', {
                        'geo.projection.rotation.lon': rotation
                    });
                }, 60);
            } else {
                isRotating = false;
                button.classList.remove('active');
                button.innerHTML = '<span class="material-icons" style="font-size: 14px; vertical-align: middle; margin-right: 6px;">rotate_right</span>Auto-Rotate';
                clearInterval(rotationInterval);
            }
        }

        function resetView() {
            Plotly.relayout('world-globe', {
                'geo.projection.rotation': { lat: 15, lon: -30, roll: 0 },
                'geo.projection.scale': 1
            });
        }

        function focusAmericas() {
            Plotly.relayout('world-globe', {
                'geo.projection.rotation': { lat: 10, lon: -95, roll: 0 },
                'geo.projection.scale': 1.9
            });
        }

        function focusEurope() {
            Plotly.relayout('world-globe', {
                'geo.projection.rotation': { lat: 25, lon: 10, roll: 0 },
                'geo.projection.scale': 2.3
            });
        }

        function focusAsia() {
            Plotly.relayout('world-globe', {
                'geo.projection.rotation': { lat: 15, lon: 120, roll: 0 },
                'geo.projection.scale': 2.1
            });
        }

        // Utility Functions
        function takeScreenshot() {
            Plotly.toImage('world-globe', {format: 'png', width: 1600, height: 1200, scale: 2})
                .then(function(url) {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `world-freight-globe-${currentMarkerStyle}-${Date.now()}.png`;
                    a.click();
                    console.log('üì∏ Screenshot saved');
                });
        }

        function toggleFullscreen() {
            const container = document.querySelector('.map-container');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                container.requestFullscreen();
            }
        }

        // Enhanced Metrics with Animation
        function updateMetrics(hubs, routes) {
            const totalCargo = hubs.reduce((sum, h) => sum + h.cargo, 0);
            const totalVolume = routes.reduce((sum, r) => sum + r.volume, 0);
            const majorHubs = hubs.filter(h => h.type === 'major').length;
            const regionalHubs = hubs.filter(h => h.type === 'regional').length;
            
            // Animate core metrics
            animateNumber('total-hubs', hubs.length);
            animateNumber('total-cargo', (totalCargo / 1000000).toFixed(1) + 'M');
            animateNumber('total-routes', routes.length);
            
            // Calculate advanced metrics
            let totalDistance = 0;
            let totalFlightTime = 0;
            
            routes.forEach(route => {
                const fromHub = getHubByCode(route.from);
                const toHub = getHubByCode(route.to);
                if (fromHub && toHub) {
                    const distance = calculateDistance(fromHub.lat, fromHub.lng, toHub.lat, toHub.lng);
                    totalDistance += distance;
                    totalFlightTime += Math.round(distance / 900); // Approximate flight time in hours
                }
            });
            
            animateNumber('avg-distance', (totalDistance / routes.length / 1000).toFixed(1) + 'K');
            
            // Network efficiency calculation
            const efficiency = Math.min(100, Math.round((totalVolume / totalDistance) * 100000));
            animateNumber('efficiency', efficiency + '%');
            
            console.log('üìä Metrics updated:', { 
                hubs: hubs.length, 
                routes: routes.length, 
                totalCargo: (totalCargo / 1000000).toFixed(1) + 'M',
                efficiency: efficiency + '%'
            });
        }

        function animateNumber(elementId, finalValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const isNumeric = !isNaN(parseFloat(finalValue));
            if (isNumeric) {
                const start = parseFloat(element.textContent) || 0;
                const end = parseFloat(finalValue);
                const suffix = finalValue.toString().replace(/[0-9.]/g, '');
                
                const duration = 800; // Faster animation
                const startTime = performance.now();
                
                function updateNumber(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    const current = start + (end - start) * easeOutCubic(progress);
                    element.textContent = (end > 10 ? Math.round(current) : current.toFixed(1)) + suffix;
                    
                    if (progress < 1) {
                        requestAnimationFrame(updateNumber);
                    }
                }
                
                requestAnimationFrame(updateNumber);
            } else {
                element.textContent = finalValue;
            }
        }

        function easeOutCubic(t) {
            return 1 - Math.pow(1 - t, 3);
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Super Functional World Freight Globe starting...');
            
            // Initialize after short delay to ensure proper rendering
            setTimeout(() => {
                initializeGlobe();
            }, 800);
            
            // Update flight speed display
            document.getElementById('flight-speed').textContent = '2.5x';
        });

        // Responsive handling
        window.addEventListener('resize', function() {
            if (document.getElementById('world-globe')) {
                Plotly.Plots.resize('world-globe');
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (isAircraftAnimating) {
                stopAircraftAnimation();
            }
            if (isRotating) {
                clearInterval(rotationInterval);
            }
        });
    </script>
</body>
</html>